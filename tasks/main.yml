---
# tasks file for perfsonar-archive

# Load OS dependant variables
- name: Load variables based on OS type
  tags: [ 'ps::config' ]
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml"
    - "{{ ansible_distribution }}.yml"
    - "{{ ansible_os_family }}.yml"

#####
# Configuration part: ps::config tag
#####
- name: Manage list of authorised IP addresses to perfsonar-archive
  tags: [ 'ps::config' ]
  include_tasks: logstash.yml
  with_items: "{{ perfsonar_archive_auth_list | default([]) }}"
  loop_control:
    loop_var: auth
  when: auth.address | default('') != ''

#####
# Verifying part: ps::running tag
#####
# Make sure services are running, but first flush handlers to ensure services are restarted
- meta: flush_handlers

- name: Check that all perfSONAR archive services are running
  tags: [ 'ps::running' ]
  service:
    name: "{{ item }}"
    state: started
  with_flattened:
      - "{{ perfsonar_archive_services }}"

